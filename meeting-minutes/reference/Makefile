# Meeting Minutes Docker Makefile
# ç®€åŒ– Docker æ“ä½œçš„å¿«æ·å‘½ä»¤

.PHONY: help build start stop restart logs status clean setup frontend ollama-init

# é»˜è®¤ç›®æ ‡
help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "ğŸ¤ Meeting Minutes Docker Commands"
	@echo "=================================="
	@echo
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "\033[36m%-15s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

setup: ## å®Œæ•´å®‰è£…ï¼ˆæ„å»ºé•œåƒå¹¶å¯åŠ¨æœåŠ¡ï¼‰
	@echo "ğŸš€ Starting full setup..."
	./setup-docker.sh

build: ## ä»…æ„å»º Docker é•œåƒ
	@echo "ğŸ”¨ Building Docker images..."
	./setup-docker.sh --build-only

start: ## å¯åŠ¨åç«¯æœåŠ¡
	@echo "â–¶ï¸  Starting backend services..."
	docker-compose up -d whisper-server summary-server ollama

stop: ## åœæ­¢æ‰€æœ‰æœåŠ¡
	@echo "â¹ï¸  Stopping all services..."
	docker-compose down

restart: ## é‡å¯æ‰€æœ‰æœåŠ¡
	@echo "ğŸ”„ Restarting services..."
	docker-compose restart

logs: ## æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
	@echo "ğŸ“‹ Showing service logs..."
	docker-compose logs -f

logs-whisper: ## æŸ¥çœ‹ Whisper æœåŠ¡æ—¥å¿—
	docker-compose logs -f whisper-server

logs-summary: ## æŸ¥çœ‹æ‘˜è¦æœåŠ¡æ—¥å¿—
	docker-compose logs -f summary-server

logs-ollama: ## æŸ¥çœ‹ Ollama æœåŠ¡æ—¥å¿—
	docker-compose logs -f ollama

status: ## æŸ¥çœ‹æœåŠ¡çŠ¶æ€
	@echo "ğŸ“Š Service Status:"
	@echo "=================="
	docker-compose ps
	@echo
	@echo "ğŸŒ Service Health:"
	@echo "=================="
	@curl -s http://localhost:8178 > /dev/null && echo "âœ… Whisper Server: Running" || echo "âŒ Whisper Server: Not responding"
	@curl -s http://localhost:5167/health > /dev/null && echo "âœ… Summary Server: Running" || echo "âŒ Summary Server: Not responding"
	@curl -s http://localhost:11434/api/tags > /dev/null && echo "âœ… Ollama: Running" || echo "âŒ Ollama: Not responding"

test: ## æµ‹è¯•æ‰€æœ‰æœåŠ¡
	@echo "ğŸ§ª Testing services..."
	@echo "Testing Whisper Server..."
	curl -f http://localhost:8178/ || echo "Whisper server test failed"
	@echo "Testing Ollama..."
	curl -f http://localhost:11434/api/tags || echo "Ollama test failed"
	@echo "Testing Summary Server..."
	curl -f http://localhost:5167/health || echo "Summary server test failed"

frontend: ## å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨
	@echo "ğŸ–¥ï¸  Starting frontend..."
	cd frontend && npm run tauri dev

frontend-install: ## å®‰è£…å‰ç«¯ä¾èµ–
	@echo "ğŸ“¦ Installing frontend dependencies..."
	cd frontend && npm install

ollama-init: ## åˆå§‹åŒ– Ollama æ¨¡å‹
	@echo "ğŸ¤– Initializing Ollama models..."
	docker-compose exec ollama ollama pull llama3.2:latest
	docker-compose exec ollama ollama pull mistral:latest

ollama-list: ## åˆ—å‡º Ollama æ¨¡å‹
	docker-compose exec ollama ollama list

shell-whisper: ## è¿›å…¥ Whisper å®¹å™¨
	docker-compose exec whisper-server bash

shell-summary: ## è¿›å…¥æ‘˜è¦æœåŠ¡å®¹å™¨
	docker-compose exec summary-server bash

shell-ollama: ## è¿›å…¥ Ollama å®¹å™¨
	docker-compose exec ollama bash

clean: ## æ¸…ç†æ‰€æœ‰ Docker èµ„æº
	@echo "ğŸ§¹ Cleaning up..."
	./setup-docker.sh --clean

clean-images: ## æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
	@echo "ğŸ—‘ï¸  Removing unused images..."
	docker image prune -f

clean-volumes: ## æ¸…ç†æ‰€æœ‰å·
	@echo "âš ï¸  This will delete all data! Press Ctrl+C to cancel..."
	@sleep 5
	docker-compose down -v

update: ## æ›´æ–°å¹¶é‡å»ºæœåŠ¡
	@echo "ğŸ”„ Updating services..."
	docker-compose pull
	docker-compose up --build -d

backup: ## å¤‡ä»½æ•°æ®å·
	@echo "ğŸ’¾ Creating backup..."
	mkdir -p backups
	docker run --rm -v meeting-minutes_whisper_models:/data -v $(PWD)/backups:/backup alpine tar czf /backup/whisper_models_$(shell date +%Y%m%d_%H%M%S).tar.gz -C /data .
	docker run --rm -v meeting-minutes_summary_data:/data -v $(PWD)/backups:/backup alpine tar czf /backup/summary_data_$(shell date +%Y%m%d_%H%M%S).tar.gz -C /data .
	docker run --rm -v meeting-minutes_ollama_data:/data -v $(PWD)/backups:/backup alpine tar czf /backup/ollama_data_$(shell date +%Y%m%d_%H%M%S).tar.gz -C /data .

restore: ## æ¢å¤æ•°æ®å·ï¼ˆéœ€è¦æŒ‡å®šå¤‡ä»½æ–‡ä»¶ï¼‰
	@echo "ğŸ“ Available backups:"
	@ls -la backups/*.tar.gz 2>/dev/null || echo "No backups found"
	@echo "Usage: make restore BACKUP=backups/filename.tar.gz"

# å¼€å‘ç›¸å…³å‘½ä»¤
dev-start: build start frontend-install ## å¼€å‘ç¯å¢ƒå¿«é€Ÿå¯åŠ¨
	@echo "ğŸš€ Development environment ready!"
	@echo "Run 'make frontend' in another terminal to start the frontend"

dev-logs: ## å¼€å‘æ¨¡å¼æ—¥å¿—ï¼ˆå½©è‰²è¾“å‡ºï¼‰
	docker-compose logs -f --tail=100

monitor: ## ç›‘æ§ç³»ç»Ÿèµ„æº
	@echo "ğŸ“Š Docker Resource Usage:"
	@echo "========================="
	docker stats --no-stream
	@echo
	@echo "ğŸ’¾ Disk Usage:"
	@echo "=============="
	docker system df

# æ•…éšœæ’é™¤
debug-whisper: ## è°ƒè¯• Whisper æœåŠ¡
	@echo "ğŸ” Whisper Server Debug Info:"
	@echo "============================="
	docker-compose exec whisper-server ls -la /app/models/
	docker-compose exec whisper-server /app/build/bin/server --help

debug-summary: ## è°ƒè¯•æ‘˜è¦æœåŠ¡
	@echo "ğŸ” Summary Server Debug Info:"
	@echo "============================="
	docker-compose exec summary-server python -c "import requests; print('Requests working')"
	docker-compose exec summary-server ls -la /app/

# æ€§èƒ½æµ‹è¯•
perf-test: ## ç®€å•æ€§èƒ½æµ‹è¯•
	@echo "âš¡ Performance Test:"
	@echo "==================="
	@echo "Testing Whisper Server response time..."
	@time curl -s http://localhost:8178/ > /dev/null
	@echo "Testing Ollama response time..."
	@time curl -s http://localhost:11434/api/tags > /dev/null

# å®‰å…¨æ£€æŸ¥
security-scan: ## æ‰«æå®¹å™¨å®‰å…¨é—®é¢˜
	@echo "ğŸ”’ Security Scan:"
	@echo "================="
	docker-compose config --quiet && echo "âœ… Compose file is valid"
	
# ä¸€é”®å¯åŠ¨ï¼ˆæ¨èï¼‰
quick-start: ## ä¸€é”®å¯åŠ¨ï¼ˆæ„å»º+å¯åŠ¨+å‰ç«¯ä¾èµ–ï¼‰
	@echo "âš¡ Quick Start..."
	@make build
	@make start
	@make frontend-install
	@echo "âœ… All services started! Run 'make frontend' to start the UI"